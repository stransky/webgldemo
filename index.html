<!DOCTYPE HTML>
<html>
<head>
<title>WebGL Demo</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<script id="vertex-vs" type="x-shader/x-vertex">
  /* OpenGL ES's shading language - Vertex shader
  */
  /* Mohu si volne definovat promene, ktere plnim daty (vertexy/barvy/textury...)
  
     Typy:
       attribute - plnene "zvenku" - vetsinou z pole
       uniform   - konstanty
       varying   - "generovane" promene - automaticky se interpoluji mezi 
                   vertexy
                   
     Jmeno promene nesmi zacinat na gl_ - tyto promene jsou vyhrazene
     pro WebGL a maji specialni vyznam, napr:
     
     gl_Position   - vysledna poloha vertexu (2D (x,y) + "hloubka" pro Z-buffer (Z) + vaha (W))
  */
  
  // Me promene s pozici vertextu a koordinatama textur
  attribute vec3 aVertexPosition;
  attribute vec2 aTextureCoord;
  
  // Me matice (View a Projection)
  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;
  
  // varying - prenasi se do pixel shaderu interpolaci mezi vertexy
  varying vec2 vTextureCoord;
      
  void main(void) {
    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
    vTextureCoord = aTextureCoord;
  }
</script>

<script id="pixel-ps" type="x-shader/x-fragment">
  /* OpenGL ES's shading language - Pixel (Fragment) shader
  */
  precision mediump float;
  
  // varying - interpolovana hodnota z vertex shaderu
  varying vec2 vTextureCoord;
  
  // konstanta - zde pro pouzitou texturu
  uniform sampler2D uTexture;
  
  void main(void) {
      gl_FragColor = texture2D(uTexture, vec2(vTextureCoord.s, vTextureCoord.t));
  }
</script>

<script type="text/javascript" src="utils/glMatrix-0.9.5.min.js"></script>
<script type="text/javascript" src="utils/webgl-utils.js"></script>

<script type="text/javascript" src="helpers.js"></script>
<script type="text/javascript" src="scene.js"></script>
<script type="text/javascript" src="textures.js"></script>
<script type="text/javascript" src="logic.js"></script>
<script type="text/javascript" src="objects.js"></script>
<script type="text/javascript" src="loaders.js"></script>
<script type="text/javascript" src="graphics.js"></script>
<script type="text/javascript" src="controls.js"></script>
<script type="text/javascript" src="camera.js"></script>

<script>  
  // Calc final matrix (modelViewMatrix)
  function modelViewMatrixSet() {
    mat4.multiply(graph.cameraMatrix, graph.worldMatrix, graph.modelViewMatrix);
  }  

  // Set matrices for shader program
  function setMatrixUniforms() {
    gl.uniformMatrix4fv(graph.shaderProgram.pMatrixUniform, false, graph.projectionMatrix);
    gl.uniformMatrix4fv(graph.shaderProgram.mvMatrixUniform, false, graph.modelViewMatrix);
  }
  
  function drawScene() {
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

    handleCamera();
    
    modelViewMatrixSet();
    setMatrixUniforms();
    /*
    gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D, globalTextures[0]);
    */
    for(cont in scene.staticObjects) {
      drawGeometryObject(scene.staticObjects[cont]);
    }
  }
    
  // Kresli scenu (hlavni smycka)
  function animationFrame() {
    // zaregistruj animationFrame pro dalsi frame
    requestAnimFrame(animationFrame);

    // dopocitej zmeny mysi
    calcMouse();

    //
    handleCameraControl();

    // Kresli scenu & spol.
    drawScene();
  }

  // Start!
  function DemoStart() {
    graphicsInit();
    inputInit();    
    
    loadTexture("test.jpg", 0);
    loadScene("test_level.json");    

    animationFrame();
  }

</script>

<body onload="DemoStart();">
    <canvas id="webgl-canvas" onmousewheel="handleWheel();" width="800" height="600">
    </canvas>
</body>
</html>
